<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drift avec Myth - Simulateur de Drift et High Score</title>
    <!-- Chargement de Tailwind CSS pour les classes utilitaires -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- STYLES CSS INT√âGR√âS (contenu de style.css) -->
    <style>
        /* Custom CSS for a racing game feel */
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@600;700&display=swap');
        
        body {
            background-color: #1a1a2e; /* Deep purple background */
            color: #ffffff;
            font-family: 'Chakra Petch', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 768px;
            background-color: #0f0f1c; /* Darker inner panel */
            border: 4px solid #e94560; /* Racing red border */
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(233, 69, 96, 0.4);
            text-align: center;
        }

        canvas {
            display: block;
            width: 100%; 
            height: auto;
            max-height: 400px;
            background-color: #272744; 
            border-radius: 10px;
            margin: 20px auto;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        /* Button Styles */
        #start-button, .action-button, .auth-button {
            transition: all 0.2s ease-in-out;
            font-weight: 700;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        
        #start-button {
            background-color: #E68120; /* Teal/Green for GO */
            color: #1a1a2e;
            font-size: 1.25rem;
            box-shadow: 0 4px #823C05;
        }
        #start-button:hover:not(:disabled) {
            background-color: #FA7D05;
            transform: translateY(-2px);
            box-shadow: 0 6px #BD641C;
        }
        #start-button:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px #823C05;
        }

        .action-button {
            background-color: #4a5568; /* Gray for actions */
            color: #ffffff;
            box-shadow: 0 3px #3c4452;
        }

        .auth-button { /* Kept for styling, but less used */
            background-color: #e94560; /* Red for auth */
            color: #ffffff;
            box-shadow: 0 3px #cc3a52;
        }

        .disabled-button {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #aaaaaa !important;
            box-shadow: 0 4px #777777 !important;
        }

        .result-text {
            min-height: 60px;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #0f0f1c;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(233, 69, 96, 0.6);
        }

        /* Responsive adjustments for mobile devices (< 640px) */
        @media (max-width: 640px) {
            .container {
                padding: 20px 10px; 
                margin: 10px; 
                border-width: 2px; 
            }
            #start-button, .action-button, .auth-button {
                font-size: 1rem;
                padding: 10px 20px;
            }
        }

        /* --- Custom Slider Styles --- */
        .custom-range-slider {
            -webkit-appearance: none; /* Remove default styling */
            appearance: none;
            width: 100%;
            height: 10px; /* Track height */
            background: #2d3748; /* Darker gray track */
            outline: none;
            border-radius: 5px;
            margin: 10px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); /* Inner shadow for depth */
        }

        .custom-range-slider::-webkit-slider-runnable-track {
            height: 10px;
            background: #2d3748;
            border-radius: 5px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            -webkit-appearance: none;
        }

        .custom-range-slider::-moz-range-track {
            height: 10px;
            background: #2d3748;
            border-radius: 5px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }

        .custom-range-slider::-ms-track {
            height: 10px;
            background: transparent; /* Needed for IE */
            border-color: transparent;
            border-width: 6px 0;
            color: transparent;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }

        /* Thumb styles */
        .custom-range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            margin-top: -5px; /* Adjust to center on track */
            cursor: grab;
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s;
            box-shadow: 0 0 8px rgba(255,255,255,0.3);
            border: 2px solid rgba(255,255,255,0.4);
        }

        .custom-range-slider::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            cursor: grab;
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s;
            box-shadow: 0 0 8px rgba(255,255,255,0.3);
            border: 2px solid rgba(255,255,255,0.4);
        }

        .custom-range-slider::-ms-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            cursor: grab;
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s;
            box-shadow: 0 0 8px rgba(255,255,255,0.3);
            border: 2px solid rgba(255,255,255,0.4);
        }

        /* Thumb specific colors and hover effects */
        .biere-slider-thumb::-webkit-slider-thumb {
            background: #4A90E2; /* Blue */
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.7);
        }
        .biere-slider-thumb::-moz-range-thumb {
            background: #4A90E2; /* Blue */
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.7);
        }
        .biere-slider-thumb::-ms-thumb {
            background: #4A90E2; /* Blue */
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.7);
        }
        .biere-slider-thumb:hover::-webkit-slider-thumb,
        .biere-slider-thumb:hover::-moz-range-thumb,
        .biere-slider-thumb:hover::-ms-thumb {
            transform: scale(1.1);
            background: #60B0FF; /* Lighter Blue */
            box-shadow: 0 0 20px rgba(96, 176, 255, 0.9);
        }

        .bedos-slider-thumb::-webkit-slider-thumb {
            background: #50E3C2; /* Teal */
            box-shadow: 0 0 15px rgba(80, 227, 194, 0.7);
        }
        .bedos-slider-thumb::-moz-range-thumb {
            background: #50E3C2; /* Teal */
            box-shadow: 0 0 15px rgba(80, 227, 194, 0.7);
        }
        .bedos-slider-thumb::-ms-thumb {
            background: #50E3C2; /* Teal */
            box-shadow: 0 0 15px rgba(80, 227, 194, 0.7);
        }
        .bedos-slider-thumb:hover::-webkit-slider-thumb,
        .bedos-slider-thumb:hover::-moz-range-thumb,
        .bedos-slider-thumb:hover::-ms-thumb {
            transform: scale(1.1);
            background: #62F7D6; /* Lighter Teal */
            box-shadow: 0 0 20px rgba(98, 247, 214, 0.9);
        }

        .ligne-slider-thumb::-webkit-slider-thumb {
            background: #BD10E0; /* Purple */
            box-shadow: 0 0 15px rgba(189, 16, 224, 0.7);
        }
        .ligne-slider-thumb::-moz-range-thumb {
            background: #BD10E0; /* Purple */
            box-shadow: 0 0 15px rgba(189, 16, 224, 0.7);
        }
        .ligne-slider-thumb::-ms-thumb {
            background: #BD10E0; /* Purple */
            box-shadow: 0 0 15px rgba(189, 16, 224, 0.7);
        }
        .ligne-slider-thumb:hover::-webkit-slider-thumb,
        .ligne-slider-thumb:hover::-moz-range-thumb,
        .ligne-slider-thumb:hover::-ms-thumb {
            transform: scale(1.1);
            background: #DB1EF2; /* Lighter Purple */
            box-shadow: 0 0 20px rgba(219, 30, 242, 0.9);
        }
        /* --- END Custom Slider Styles --- */

    </style>
</head>
<body>

<div class="container">
    <div class="flex justify-between items-center mb-6">
        <div id="auth-status" class="text-sm font-medium text-gray-400 text-left flex items-center">
            <span>Chargement...</span>
            <button id="edit-username-button" class="ml-2 text-pink-400 hover:text-pink-300 text-xs font-bold py-1 px-2 rounded-md border border-pink-400 hidden" onclick="showEditUsernameModal()">Modifier</button>
        </div>
        <div>
            <!-- No auth toggle anymore -->
        </div>
    </div>
    
    <h1 class="text-3xl font-bold mb-2 text-pink-400">Drift avec Myth</h1>
    
    <!-- MOVED AND MODIFIED: SECTION CLASSEMENT GLOBAL IS NOW HERE AND ONLY DISPLAYS TOP 3 -->
    <div class="mt-8 mb-6">
        <h2 class="text-2xl font-bold mb-4 text-yellow-400">üèÜ Top 3 Mythes</h2>
        <div id="leaderboard" class="bg-gray-800 p-4 rounded-lg shadow-inner">
            <p class="text-gray-400">Chargement du classement...</p>
        </div>
    </div>
    <!-- END MOVED AND MODIFIED SECTION -->

    <div id="high-score" class="text-xl font-extrabold mb-4 text-yellow-300">
        Meilleur Score: 0 tours
    </div>
    <p class="mb-6 text-gray-300">Myth survivra-t-il dans sa Polo ? Bois, fume ou reste sobre, c'est √† tes risques et p√©rils.</p>

    <!-- NEW: Bi√®res Slider -->
    <div class="mb-4">
        <label for="bieres-slider" class="block text-lg font-bold mb-2 text-blue-400">
            Bi√®res (1 point/bi√®re) : <span id="bieres-value">0</span> üç∫
        </label>
        <input type="range" id="bieres-slider" min="0" max="5" value="0" class="custom-range-slider biere-slider-thumb">
    </div>
    <!-- NEW: Bedos Slider -->
    <div class="mb-4">
        <label for="bedos-slider" class="block text-lg font-bold mb-2 text-green-400">
            Pets (1 point/pet) : <span id="bedos-value">0</span> üö¨
        </label>
        <input type="range" id="bedos-slider" min="0" max="5" value="0" class="custom-range-slider bedos-slider-thumb">
    </div>
    <!-- NEW: Ligne Slider -->
    <div class="mb-6">
        <label for="ligne-slider" class="block text-lg font-bold mb-2 text-purple-400">
            Canettes Energy (2 points/canette) : <span id="ligne-value">0</span> ‚ö°Ô∏è
        </label>
        <input type="range" id="ligne-slider" min="0" max="2" value="0" class="custom-range-slider ligne-slider-thumb">
    </div>

<div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-6">
<p class="text-sm text-gray-400 mt-2">Influence al√©atoire sur le risque de crash ! Positif ou N√©gatif, tout d√©pend de l'√©tat psychologique du Myth</p>
</div>

    <!-- NEW: Points Remaining Display -->
    <p id="points-status" class="text-xl font-bold mb-6 text-yellow-300">
        Points de chance disponibles : <span id="points-remaining">5</span> / 5
    </p>

    <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-6">
        <button id="start-button" onclick="runSimulation()">
            DRIFT
        </button>
        <p id="current-status" class="text-xl font-semibold text-yellow-300">Pr√™t</p>
    </div>

    <canvas id="race-track" width="600" height="300"></canvas>
    
    <div id="results" class="result-text mt-6 text-2xl font-extrabold">
        <!-- Les r√©sultats seront affich√©s ici -->
    </div>
</div>

<div id="edit-username-modal" class="modal">
    <div class="modal-content">
        <h2 class="text-2xl font-bold mb-4 text-pink-400">Choisir un Nom d'Utilisateur</h2>
        <form id="username-form" onsubmit="handleUsernameEditSubmit(event)">
            <input type="text" id="new-username-input" placeholder="Votre Nom d'Utilisateur" required minlength="3" maxlength="20"
                   class="w-full p-3 mb-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:ring-pink-500 focus:border-pink-500">
            <p id="username-error" class="text-red-400 mb-4 h-6"></p>
            <button type="submit" class="action-button w-full mb-3">
                Sauvegarder
            </button>
            <button type="button" class="auth-button w-full" onclick="document.getElementById('edit-username-modal').style.display='none'">
                Annuler
            </button>
        </form>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const GITHUB_FIREBASE_CONFIG = {
        apiKey: "AIzaSyBsWugLEz2bu5xjbR5VtYXMr7cUhD6ycEE",
        authDomain: "lapolo-5351b.firebaseapp.com",
        projectId: "lapolo-5351b", 
        storageBucket: "lapolo-5351b.firebasestorage.app",
        messagingSenderId: "1031146720807",
        appId: "1:1031146720807:web:6324e1b371bbb953410802"
    };
    const GITHUB_APP_ID = GITHUB_FIREBASE_CONFIG.projectId || 'local-github-app';

    const isCanvas = typeof __app_id !== 'undefined';
    
    const appId = isCanvas 
        ? __app_id 
        : GITHUB_APP_ID;
    const firebaseConfig = isCanvas 
        ? JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}')
        : GITHUB_FIREBASE_CONFIG;
    const initialAuthToken = null; 
    
    const isGithubPlaceholder = !isCanvas && (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY_GOES_HERE");
    
    let app;
    let db;
    let auth;
    let userId = null;
    let currentHighScore = 0;
    let currentUsername = null; 
    
    const BASE_CRASH_CHANCE = 0.20; 
    let currentCrashChance = BASE_CRASH_CHANCE; // This will be the actual chance used in the game

    // NEW: Constants for point system
    const MAX_POINTS = 5;
    const BIERE_COST = 1;
    const BEDOS_COST = 1;
    const LIGNE_COST = 2;

    let isRacing = false;
    let lapCount = 0;
    let angle = 0; 
    let anglePerFrame = 0.05; 
    let crashLapNumber = -1; 
    let animationFrameId;

    const canvas = document.getElementById('race-track');
    const ctx = canvas.getContext('2d');
    const statusText = document.getElementById('current-status');
    const resultsDiv = document.getElementById('results');
    const startButton = document.getElementById('start-button');
    const authStatusDiv = document.getElementById('auth-status');
    const highScoreDiv = document.getElementById('high-score');
    const leaderboardDiv = document.getElementById('leaderboard'); 
    const editUsernameButton = document.getElementById('edit-username-button'); 

    // Slider elements
    const bieresSlider = document.getElementById('bieres-slider');
    const bieresValueSpan = document.getElementById('bieres-value');
    const bedosSlider = document.getElementById('bedos-slider');
    const bedosValueSpan = document.getElementById('bedos-value');
    const ligneSlider = document.getElementById('ligne-slider');
    const ligneValueSpan = document.getElementById('ligne-value');
    const pointsRemainingSpan = document.getElementById('points-remaining');

    let centerX, centerY, radiusX, radiusY;

    const editUsernameModal = document.getElementById('edit-username-modal');
    const newUsernameInput = document.getElementById('new-username-input');
    const usernameError = document.getElementById('username-error');

    function getHighScoreDocRef() {
        if (!db || !userId) return null;
        return doc(db, 'artifacts', appId, 'users', userId, 'game_data', 'high_score');
    }

    async function fetchHighScore() {
        if (isGithubPlaceholder || !userId || !db) return 0;
        try {
            const docRef = getHighScoreDocRef();
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                currentHighScore = docSnap.data().maxLaps || 0;
            } else {
                currentHighScore = 0;
            }
            highScoreDiv.textContent = `Meilleur Score: ${currentHighScore} tours`;
            return currentHighScore;
        } catch (error) {
            console.error("Erreur lors de la r√©cup√©ration du score:", error);
            return 0;
        }
    }

    async function updateHighScore(newScore) {
        if (isGithubPlaceholder || !userId || !db) {
             console.warn("Sauvegarde des scores ignor√©e : Firebase non configur√© ou mode local.");
             currentHighScore = Math.max(currentHighScore, newScore);
             highScoreDiv.textContent = `Meilleur Score: ${currentHighScore} tours (Local)`;
             return;
        }
        
        if (newScore > currentHighScore) {
            try {
                const docRef = getHighScoreDocRef();
                await setDoc(docRef, { maxLaps: newScore }, { merge: true });
                
                currentHighScore = newScore;
                highScoreDiv.textContent = `Meilleur Score: ${currentHighScore} tours`;
                console.log("Meilleur score mis √† jour:", newScore);

                if (auth.currentUser && currentUsername && currentUsername.trim().length > 0) {
                     updateGlobalScore(newScore, currentUsername);
                } else {
                    console.warn("Global leaderboard update skipped: Username not set or empty. Prompting user.");
                    showEditUsernameModal(); 
                }

            } catch (error) {
                console.error("Erreur lors de la mise √† jour du score:", error);
            }
        }
    }

    async function updateGlobalScore(newScore, username) {
        if (isGithubPlaceholder || !db || !auth.currentUser || !username || username.trim().length === 0) {
            console.warn("Global leaderboard update prevented by security rules/missing data (username invalid).");
            return; 
        }

        try {
            const globalDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'global_high_scores', auth.currentUser.uid);
            
            const docSnap = await getDoc(globalDocRef);
            const existingGlobalScore = docSnap.exists() ? docSnap.data().maxLaps : 0;

            if (newScore > existingGlobalScore) {
                await setDoc(globalDocRef, {
                    userId: auth.currentUser.uid,
                    username: username,
                    maxLaps: newScore,
                    updatedAt: new Date().toISOString()
                });
                console.log("Score global mis √† jour:", newScore);
                fetchGlobalLeaderboard(); 
            }

        } catch (error) {
            console.error("Erreur lors de la mise √† jour du score global:", error);
        }
    }
    
    async function fetchGlobalLeaderboard() {
        if (isGithubPlaceholder || !db) {
            leaderboardDiv.innerHTML = '<p class="text-yellow-500">Le classement est d√©sactiv√©. Configurez Firebase pour le voir.</p>';
            return;
        }

        try {
            const leaderboardCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'global_high_scores');
            
            // FIX: Limit the query to only 3 results for the top 3 ranking
            const q = query(leaderboardCollectionRef, orderBy('maxLaps', 'desc'), limit(3));
            const querySnapshot = await getDocs(q);

            let html = '';
            if (querySnapshot.empty) {
                html = '<p class="text-gray-400">Aucun score enregistr√©. Soyez le premier !</p>';
            } else {
                for (let i = 0; i < querySnapshot.docs.length; i++) {
                    const docSnap = querySnapshot.docs[i];
                    const data = docSnap.data();
                    
                    const rank = i + 1;

                    // console.log(`DEBUG: Leaderboard entry - loop index: ${i}, calculated rank: ${rank}, username: ${data.username || 'Unknown'}, score: ${data.maxLaps}`);

                    let displayRankString;
                    let medalColorClass;

                    if (rank === 1) {
                        displayRankString = 'ü•á #1';
                        medalColorClass = 'text-yellow-300';
                    } else if (rank === 2) {
                        displayRankString = 'ü•à #2';
                        medalColorClass = 'text-gray-300';
                    } else if (rank === 3) {
                        displayRankString = 'ü•â #3';
                        medalColorClass = 'text-amber-500';
                    } else {
                        // This else block technically won't be hit with limit(3), but good for safety
                        displayRankString = `#${rank}`;
                        medalColorClass = 'text-gray-400';
                    }
                    
                    const highlightClass = (data.userId === userId && auth.currentUser) ? 'bg-pink-800/50' : 'hover:bg-gray-700/50';

                    html += `
                        <div class="flex justify-between items-center p-3 my-1 rounded-lg ${highlightClass}">
                            <span class="text-xl font-extrabold ${medalColorClass}">${displayRankString}</span>
                            <span class="text-lg font-semibold">${data.username || 'Utilisateur inconnu'}</span>
                            <span class="text-lg font-bold text-teal-400">${data.maxLaps} tours</span>
                        </div>
                    `;
                }
            }
            leaderboardDiv.innerHTML = html;

        } catch (error) {
            console.error("Erreur lors de la r√©cup√©ration du classement:", error);
            leaderboardDiv.innerHTML = '<p class="text-red-400">Erreur lors du chargement du classement.</p>';
        }
    }

    async function fetchUserProfile(uid) {
        if (isGithubPlaceholder || !db) return '';
        try {
            const profileDocRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
            const docSnap = await getDoc(profileDocRef);
            return docSnap.exists() ? (docSnap.data().username || '') : ''; 
        } catch (error) {
            console.error("Erreur lors de la r√©cup√©ration du profil:", error);
            return '';
        }
    }

    async function saveUserProfile(uid, username) {
        if (isGithubPlaceholder || !db) return;
        try {
            const profileDocRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
            await setDoc(profileDocRef, { username: username, createdAt: new Date().toISOString() }, { merge: true });
        } catch (error) {
            console.error("Erreur lors de la sauvegarde du profil:", error);
        }
    }

    function updateAuthUI(user) {
        if (isGithubPlaceholder) {
            authStatusDiv.querySelector('span').textContent = 'Mode Local (Scores non sauvegard√©s).';
            editUsernameButton.style.display = 'none';
            highScoreDiv.textContent = `Meilleur Score: ${currentHighScore} tours (Local)`;
            return;
        }

        if (user) {
            userId = user.uid;
            
            fetchUserProfile(user.uid).then(username => {
                currentUsername = username;
                
                authStatusDiv.querySelector('span').innerHTML = `Connect√© comme : <span class="text-pink-400">${username || 'Anonyme'}</span>`;
                editUsernameButton.style.display = 'inline-block';

                if (!currentUsername || currentUsername.trim().length === 0) {
                    console.log("Username is missing, prompting user to set one.");
                    setTimeout(() => {
                        showEditUsernameModal();
                    }, 500); 
                }
            });
            
            fetchHighScore(); 
            fetchGlobalLeaderboard(); 
        } else {
            userId = null;
            currentUsername = null;
            currentHighScore = 0;
            authStatusDiv.querySelector('span').textContent = 'Non connect√©. Connectez-vous pour sauvegarder votre score.';
            highScoreDiv.textContent = 'Meilleur Score: 0 tours';
            editUsernameButton.style.display = 'none';
        }
    }

    async function initializeFirebase() {
        if (isGithubPlaceholder) {
            console.warn("‚ö†Ô∏è Mode GitHub sans configuration Firebase : La sauvegarde des scores et l'authentification sont d√©sactiv√©es.");
            updateAuthUI(null); 
            return;
        }
        
        if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
            console.error("Erreur: Configuration Firebase incompl√®te.");
            authStatusDiv.querySelector('span').textContent = 'ERREUR FIREBASE. Configuration manquante. V√©rifiez la console.';
            return;
        }

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app); 

            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    await signInAnonymously(auth);
                } else {
                    updateAuthUI(user);
                }
            });

            if (!auth.currentUser) {
                 await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Erreur fatale lors de l'initialisation de Firebase:", error);
            authStatusDiv.querySelector('span').textContent = 'ERREUR FIREBASE FATALE. V√©rifiez la console et votre configuration.';
            db = null;
            auth = null;
        }
    }

    window.showEditUsernameModal = () => {
        if (isGithubPlaceholder || !auth.currentUser) return;
        newUsernameInput.value = currentUsername || '';
        usernameError.textContent = '';
        editUsernameModal.style.display = 'flex';
    };

    window.handleUsernameEditSubmit = async (event) => {
        event.preventDefault();
        const newUsername = newUsernameInput.value.trim();
        usernameError.textContent = '';

        if (!newUsername || newUsername.length < 3 || newUsername.length > 20) {
            usernameError.textContent = 'Le nom d\'utilisateur doit contenir entre 3 et 20 caract√®res.';
            return;
        }
        if (newUsername === currentUsername) {
            editUsernameModal.style.display = 'none';
            return;
        }

        try {
            if (auth.currentUser && auth.currentUser.uid) {
                await saveUserProfile(auth.currentUser.uid, newUsername);
                currentUsername = newUsername;
                updateAuthUI(auth.currentUser);
                fetchGlobalLeaderboard();
                editUsernameModal.style.display = 'none';
                console.log("Nom d'utilisateur mis √† jour:", newUsername);
            }
        } catch (error) {
            console.error("Erreur lors de la mise √† jour du nom d'utilisateur:", error);
            usernameError.textContent = 'Erreur lors de la sauvegarde du nom. Veuillez r√©essayer.';
        }
    };

    function resizeCanvas() {
        const parent = canvas.parentElement;
        const desiredWidth = parent.clientWidth;
        const desiredHeight = desiredWidth / 2; 

        canvas.width = desiredWidth > 600 ? 600 : desiredWidth;
        canvas.height = desiredHeight > 300 ? 300 : desiredHeight;

        centerX = canvas.width / 2;
        centerY = canvas.height / 2;
        radiusX = centerX * 0.7; 
        radiusY = centerY * 0.7; 
        
        if (!isRacing) {
            drawTrack(false);
        }
    }

    window.addEventListener('resize', resizeCanvas);

    function drawTrack(isCrashed = false) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. Draw Racing Green Grass (infield)
        ctx.fillStyle = '#272744';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 2. Draw Outer Track Boundary (White Line)
        ctx.beginPath();
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
        ctx.lineWidth = 15;
        ctx.ellipse(centerX, centerY, radiusX + 15, radiusY + 15, 0, 0, 2 * Math.PI);
        ctx.stroke();

        // 3. Draw Track Surface (Asphalt)
        ctx.beginPath();
        ctx.fillStyle = '#3c4048'; // Dark asphalt gray
        ctx.ellipse(centerX, centerY, radiusX + 5, radiusY + 5, 0, 0, 2 * Math.PI);
        ctx.fill();

        // 4. Draw Inner Track Boundary (White Line)
        ctx.beginPath();
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
        ctx.lineWidth = 10;
        
        const innerRadiusX = Math.max(1, radiusX - 10);
        const innerRadiusY = Math.max(1, radiusY - 10);
        
        ctx.ellipse(centerX, centerY, innerRadiusX, innerRadiusY, 0, 0, 2 * Math.PI);
        ctx.stroke();

        // 5. Draw Start/Finish Line (Red/White stripes)
        const startX = centerX + radiusX;
        const startY = centerY;
        
        ctx.lineWidth = 5;
        ctx.strokeStyle = 'white';
        ctx.beginPath();
        ctx.moveTo(startX, startY - 15);
        ctx.lineTo(startX, startY + 15);
        ctx.stroke();
        
        ctx.strokeStyle = '#e94560'; // Red
        ctx.beginPath();
        ctx.moveTo(startX, startY - 10);
        ctx.lineTo(startX, startY + 10);
        ctx.stroke();

        // 6. Draw Car
        let currentAngle = angle;
        
        // Calculate car position on the ellipse
        const carX = centerX + radiusX * Math.cos(currentAngle);
        const carY = centerY + radiusY * Math.sin(currentAngle);

        // Calculate car rotation (tangent to the ellipse path)
        const dx = -radiusX * Math.sin(currentAngle);
        const dy = radiusY * Math.cos(currentAngle);
        const rotation = Math.atan2(dy, dx);

        ctx.save();
        ctx.translate(carX, carY);
        ctx.rotate(rotation);

        if (isCrashed) {
            const crashJitterX = Math.random() * 8 - 4;
            const crashJitterY = Math.random() * 8 - 4;
            ctx.rotate(Math.PI / 8); 
            ctx.translate(crashJitterX, crashJitterY);
        }

        // Car Body (The "Polo") - Set to Dark Green or Red if crashed
        ctx.fillStyle = isCrashed ? '#ff0000' : '#1e4620';
        ctx.fillRect(-15, -8, 30, 16);
        
        // Cabin
        ctx.fillStyle = '#222222';
        ctx.fillRect(-5, -6, 10, 8); 

        // Headlights (only if not crashed)
        if (!isCrashed) {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(12, -6, 3, 2);
            ctx.fillRect(12, 4, 3, 2);
        }

        // Wheels
        ctx.fillStyle = '#333333';
        ctx.beginPath();
        ctx.arc(-10, -8, 4, 0, 2 * Math.PI); ctx.fill();
        ctx.beginPath();
        ctx.arc(-10, 8, 4, 0, 2 * Math.PI); ctx.fill();
        ctx.beginPath();
        ctx.arc(10, -8, 4, 0, 2 * Math.PI); ctx.fill();
        ctx.beginPath();
        ctx.arc(10, 8, 4, 0, 2 * Math.PI); ctx.fill();

        ctx.restore();

        // Draw Crash Smoke/Particles if crashed
        if (isCrashed) {
            for(let i = 0; i < 20; i++) {
                const smokeX = carX + (Math.random() - 0.5) * 40;
                const smokeY = carY + (Math.random() - 0.5) * 40;
                const smokeRadius = Math.random() * 10 + 5;
                ctx.fillStyle = `rgba(150, 150, 150, ${Math.random() * 0.6})`;
                ctx.beginPath();
                ctx.arc(smokeX, smokeY, smokeRadius, 0, 2 * Math.PI);
                ctx.fill();
            }
        }
    }

    // NEW: Function to calculate the total crash chance based on all inputs
    function calculateTotalCrashChance(bieresCount, bedosCount, ligneCount) {
        let finalCrashChance = BASE_CRASH_CHANCE;

        // Apply Bi√®res and Bedos risk (33% increase, 33% decrease, 34% no change)
        const applyCommonRisk = (count, currentChance) => {
            if (count === 0) return currentChance;
            let modifier = 0;
            switch (count) {
                case 1: modifier = 0.05; break;
                case 2: modifier = 0.10; break;
                case 3: modifier = 0.15; break;
                case 4:
                case 5: modifier = 0.20; break;
            }
            const randomRoll = Math.random();
            if (randomRoll < 0.33) { // 33% chance to increase
                return Math.min(1, currentChance * (1 + modifier));
            } else if (randomRoll < 0.66) { // 33% chance to decrease
                return Math.max(0, currentChance * (1 - modifier));
            } else { // Remaining 34% chance to stay the same
                return currentChance;
            }
        };

        finalCrashChance = applyCommonRisk(bieresCount, finalCrashChance);
        finalCrashChance = applyCommonRisk(bedosCount, finalCrashChance); // Bedos uses the same logic

        // Apply Ligne risk (dynamic activation chance, fixed 50% modifier)
        if (ligneCount > 0) {
            const ligneActivationChance = ligneCount * 0.10; // 1 Ligne = 10%, 2 Lignes = 20%
            const ligneModifierMagnitude = 0.50; // Fixed 50% increase or decrease

            if (Math.random() < ligneActivationChance) { 
                if (Math.random() < 0.50) { // 50% chance to increase
                    finalCrashChance = Math.min(1, finalCrashChance * (1 + ligneModifierMagnitude));
                } else { // 50% chance to decrease
                    finalCrashChance = Math.max(0, finalCrashChance * (1 - ligneModifierMagnitude));
                }
            }
        }

        // NEW: Apply special good luck bonus for 2 Bi√®res, 1 Bedos, 1 Ligne
        if (bieresCount === 2 && bedosCount === 1 && ligneCount === 1) {
            if (Math.random() < 0.50) { // 50% chance of good luck
                finalCrashChance = Math.max(0, finalCrashChance * 0.50); // Reduce risk by 50%
                console.log("SPECIAL BONUS! Good luck activated, crash chance significantly reduced!");
            } else {
                console.log("SPECIAL BONUS! Good luck did not activate this time.");
            }
        }

        return finalCrashChance;
    }

    // Function to calculate total points spent
    function calculateCurrentPoints() {
        const bieres = parseInt(bieresSlider.value, 10);
        const bedos = parseInt(bedosSlider.value, 10);
        const ligne = parseInt(ligneSlider.value, 10);
        return (bieres * BIERE_COST) + (bedos * BEDOS_COST) + (ligne * LIGNE_COST);
    }

    // Function to update point display and start button state
    function updatePointDisplayAndButton() {
        const currentPoints = calculateCurrentPoints();
        const remainingPoints = MAX_POINTS - currentPoints;
        pointsRemainingSpan.textContent = remainingPoints;

        if (currentPoints > MAX_POINTS) {
            pointsRemainingSpan.classList.add('text-red-500');
            startButton.disabled = true;
            startButton.classList.add('disabled-button');
            startButton.textContent = 'D√©passement de points !';
        } else {
            pointsRemainingSpan.classList.remove('text-red-500');
            // Only re-enable if not currently racing
            if (!isRacing) {
                startButton.disabled = false;
                startButton.classList.remove('disabled-button');
                startButton.textContent = 'DRIFT';
            }
        }
    }


    function gameLoop() {
        if (!isRacing) {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            return;
        }

        angle += anglePerFrame;

        if (angle >= (lapCount + 1) * 2 * Math.PI) {
            
            lapCount++;
            statusText.textContent = `Tour ${lapCount}`; 

            // MODIFIED: Use currentCrashChance instead of fixed CRASH_CHANCE
            if (Math.random() < currentCrashChance) { 
                crashLapNumber = lapCount;
                endSimulation(true);
                return;
            }
        }
        
        drawTrack();
        
        animationFrameId = requestAnimationFrame(gameLoop);
    };

    window.runSimulation = () => {
        if (isRacing) return;

        if (!userId) { 
            resultsDiv.classList.add('text-red-400');
            resultsDiv.innerHTML = `‚ö†Ô∏è Veuillez patienter, l'application est en cours d'initialisation...`;
            return;
        }

        // Check points before starting
        if (calculateCurrentPoints() > MAX_POINTS) {
            resultsDiv.classList.add('text-red-400');
            resultsDiv.innerHTML = `üö´ **ATTENTION :** Vous avez d√©pens√© trop de points ! Diminuez vos consommations.`;
            return;
        }

        // NEW: Calculate crash chance for this run based on all selected items and any special bonuses
        currentCrashChance = calculateTotalCrashChance(
            parseInt(bieresSlider.value, 10),
            parseInt(bedosSlider.value, 10),
            parseInt(ligneSlider.value, 10)
        );
        console.log(`Starting run with ${bieresSlider.value} bi√®res, ${bedosSlider.value} bedos, ${ligneSlider.value} lignes. Final effective crash chance: ${currentCrashChance.toFixed(4)}`);

        isRacing = true;
        lapCount = 0;
        angle = 0;
        crashLapNumber = -1; 
        resultsDiv.innerHTML = '';
        
        startButton.disabled = true;
        startButton.classList.add('disabled-button');
        startButton.textContent = 'COURSE EN COURS...';
        statusText.textContent = `Tour 1`; 

        // Disable all sliders while racing
        bieresSlider.disabled = true;
        bieresSlider.classList.add('opacity-50', 'cursor-not-allowed');
        bedosSlider.disabled = true;
        bedosSlider.classList.add('opacity-50', 'cursor-not-allowed');
        ligneSlider.disabled = true;
        ligneSlider.classList.add('opacity-50', 'cursor-not-allowed');

        animationFrameId = requestAnimationFrame(gameLoop);
    };

    function endSimulation(crashed) {
        isRacing = false;
        
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }

        if (crashed) {
            drawTrack(true); 
            resultsDiv.classList.remove('text-green-400');
            resultsDiv.classList.add('text-red-400');
            resultsDiv.innerHTML = `üö® **CRASH !** Myth s'est √©cras√© au Tour ${crashLapNumber} ! üíî`;

            updateHighScore(crashLapNumber); 
        } 
        
        setTimeout(() => {
            // Re-enable start button, it will be disabled if points are over budget
            updatePointDisplayAndButton(); 
            startButton.textContent = 'D√©marrer une nouvelle course !';
            statusText.textContent = 'Course Termin√©e';
            // Enable sliders after race ends
            bieresSlider.disabled = false;
            bieresSlider.classList.remove('opacity-50', 'cursor-not-allowed');
            bedosSlider.disabled = false;
            bedosSlider.classList.remove('opacity-50', 'cursor-not-allowed');
            ligneSlider.disabled = false;
            ligneSlider.classList.remove('opacity-50', 'cursor-not-allowed');
        }, 1500);
    }

    window.onload = function() {
        resizeCanvas();
        drawTrack();
        initializeFirebase();

        // Initialize slider value displays and point counter
        bieresValueSpan.textContent = bieresSlider.value;
        bedosValueSpan.textContent = bedosSlider.value;
        ligneValueSpan.textContent = ligneSlider.value;
        updatePointDisplayAndButton(); // Initial check

        // Add event listeners for all slider inputs
        bieresSlider.addEventListener('input', () => {
            bieresValueSpan.textContent = bieresSlider.value;
            updatePointDisplayAndButton();
        });
        bedosSlider.addEventListener('input', () => {
            bedosValueSpan.textContent = bedosSlider.value;
            updatePointDisplayAndButton();
        });
        ligneSlider.addEventListener('input', () => {
            ligneValueSpan.textContent = ligneSlider.value;
            updatePointDisplayAndButton();
        });
    }
</script>

</body>
</html>


